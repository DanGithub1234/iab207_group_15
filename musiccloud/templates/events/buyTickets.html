{% extends 'base.html' %}

{% from 'bootstrap5/form.html' import render_form %}

{% block content %}
    
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="container-fluid d-flex justify-content-center">
      <div class="row mt-3" style="min-width: 40%;">
        <div class="col-md-12">
          {% for message in messages %}
            <div class="alert alert-info flash-info">{{ message }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
{% endwith %}

 <!-- Event details -->
    <div class="p-5 row">

        <div class="col-md-7 p-5">
            <div class="home-content">
        
                <p class="h1">{{event.name}}</p>
                <p class="card-text mb-1" style="color: black;">{{event.description}}</p>
                <p class="card-text mb-1" style="color: black;"><strong>Genre:</strong> {{event.genre}}</p>
                <p class="card-text mb-1" style="color: black;"><strong>Location:</strong> {{event.location}}</p>
                <p class="card-text mb-1" style="color: black;"><strong>Date:</strong> {{event.event_date}}</p>
                <p class="card-text mb-1" style="color: black;"><strong>Time:</strong> Start: {{event.start_time}}, End: {{event.end_time}}</p>
            </div>

        </div>
    </div>

    <div class="card custom-card-ticket">
  <div class="card-header custom-card-ticket-header"><strong>Complete your purchase</strong></div>
  <div class="card-body custom-card-body">

<!-- ticket purchase form -->
    <form method="POST" action="{{ url_for('event.buyTickets', id=event.id) }}">

  <!--ticket details -->
  <h4 class="mb-3">Ticket Details</h4>
  <div class="row g-3">
    <div class="col-md-6">
      <label for="ticket_type" class="form-label">Ticket Price: ${{event.ticket_price}}</label>
    </div>

    <div class="col-md-6">
      <label for="quantity" class="form-label">Number of Tickets</label>
        <!-- sets limit to ticket order to prevent overbooking and negative booking -->
        {# qty_max is provided by the route; fallback to 10 if missing #}
        {% set qty_max_val = qty_max if qty_max is defined else 10 %}

<input
  type="number"
  id="quantity"
  name="quantity"
  class="form-control {% if qty_error %}is-invalid{% endif %}"
  min="1"
  max="{{ qty_max_val }}"
  value="{{ qty_value if qty_value is defined else 1 }}"
  required
>

{% if qty_error %}
        <!-- if there's an error in quantity it shows under the field -->
  <div class="invalid-feedback d-block">
    {{ qty_error }}
  </div>
{% else %}
  <div class="form-text">Max {{ qty_max_val }} per order.</div>
{% endif %}
</div>
  </div>    


  <hr class="my-4">

  <!-- billing information -->
  <h4 class="mb-3">Billing Information</h4>
  <input type="text" id="billing_address" name="billing_address" class="form-control" placeholder="Billing address (optional)">

  <hr class="my-4">

  <!-- final confirmation -->
  <h4 class="mb-3">Final Confirmation</h4>
  <p class="mb-2" style="color:black;">
 
      <!-- calculates transaction total -->
      <strong>Total:</strong> (Ticket Price Ã— Quantity) + $5 One Time Booking Fee
</p>

  <div class="form-check mb-3">  <!-- user must tick this box to agree to the terms and conditions to complete boking -->
    <input class="form-check-input" type="checkbox" id="agree" name="agree" required>
    <label class="form-check-label" for="agree">I agree to Terms &amp; Conditions / Refund Policy</label>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <button type="submit" class="custom-button-categories-small">Confirm &amp; Pay</button>
  </div>
</form>
      
  </div>
</div>

<!-- Thank You Confirmation modal after user successfully books a ticket  -->
<div id="thankYouModal"
     class="modal fade {% if show_modal %}show{% endif %}"
     tabindex="-1"
     aria-hidden="{% if show_modal %}false{% else %}true{% endif %}"
     {% if show_modal %}style="display:block;"{% endif %}>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content custom-card-ticket">
      <div class="modal-header custom-card-ticket-header">
        <h5 class="modal-title">Thank you!</h5>
        <a href="{{ url_for('main.index') }}" class="btn-close" aria-label="Close"></a>
      </div>
      <div class="modal-body custom-card-body text-center">
        <p>Your ticket has been successfully purchased.</p>
        {% if booking_id %}<p>Booking ID: {{ booking_id }}</p>{% endif %}
        <p>Thanks for using <strong>musicCloud</strong>!</p>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('main.index') }}" class="custom-button-categories-small" style="text-decoration: none;">
          Back to Home
        </a>
      </div>
    </div>
  </div>
</div>

{% if show_modal %}
  <div class="modal-backdrop fade show"></div>
  <style> html, body { overflow: hidden; } </style>
{% endif %}

    <!-- footer -->
</body>

</html>
{% endblock %}
